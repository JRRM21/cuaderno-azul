!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JR LibreIA ‚Äì Cuaderno Azul</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb" />
    <meta name="description" content="Cuaderno digital para capturar notas escritas a mano o dictadas" />
    <link
      rel="manifest"
      href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkpSIExpYnJlSUEg4oCTIEN1YWRlcm5vIEF6dWwiLAogICJzaG9ydF9uYW1lIjogIkN1YWRlcm5vIEF6dWwiLAogICJkZXNjcmlwdGlvbiI6ICJDdWFkZXJubyBkaWdpdGFsIHBhcmEgY2FwdHVyYXIgbm90YXMgZXNjcml0YXMgYSBtYW5vIG8gZGljdGFkYXMiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMyNTYzZWIiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LEVBWkFBUUFBQUVBQUlBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0="
    />

    <style>
      :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --secondary-color: #f8fafc;
        --text-color: #1e293b;
        --border-color: #e2e8f0;
        --success-color: #22c55e;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --high-contrast-bg: #000000;
        --high-contrast-text: #ffffff;
        --high-contrast-button: #ffff00;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: 18px;
        line-height: 1.6;
        color: var(--text-color);
        background: var(--secondary-color);
        min-height: 100vh;
      }
      .app-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .logo {
        font-size: 28px;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 8px;
      }
      .subtitle {
        color: #64748b;
        font-size: 16px;
      }
      .btn {
        display: block;
        width: 100%;
        padding: 20px 24px;
        margin: 12px 0;
        font-size: 20px;
        font-weight: 600;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        text-decoration: none;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }
      .btn-primary {
        background: var(--primary-color);
        color: white;
      }
      .btn-primary:hover,
      .btn-primary:focus {
        background: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
      }
      .btn-secondary {
        background: white;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
      }
      .btn-secondary:hover,
      .btn-secondary:focus {
        background: var(--primary-color);
        color: white;
      }
      .btn-success {
        background: var(--success-color);
        color: white;
      }
      .btn-warning {
        background: var(--warning-color);
        color: white;
      }
      .btn-danger {
        background: var(--danger-color);
        color: white;
      }
      .screen {
        display: none;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .screen.active {
        display: block;
      }
      .screen-title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        color: var(--primary-color);
        text-align: center;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .label {
        display: block;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
      }
      .input,
      .textarea,
      select.input {
        width: 100%;
        padding: 16px;
        font-size: 18px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: white;
      }
      .input:focus,
      .textarea:focus,
      select.input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }
      .textarea {
        min-height: 120px;
        resize: vertical;
      }
      .image-upload {
        border: 3px dashed var(--border-color);
        border-radius: 12px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .image-upload:hover {
        border-color: var(--primary-color);
        background: #f8fafc;
      }
      .image-upload.dragover {
        border-color: var(--primary-color);
        background: #eff6ff;
      }
      .image-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        margin: 20px 0;
      }
      .history-item {
        background: #f8fafc;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin: 12px 0;
      }
      .history-meta {
        font-size: 14px;
        color: #64748b;
        margin-bottom: 8px;
      }
      .history-preview {
        font-size: 16px;
        margin-bottom: 12px;
      }
      .history-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .btn-small {
        padding: 8px 16px;
        font-size: 14px;
        min-height: auto;
      }
      body.high-contrast {
        background: var(--high-contrast-bg);
        color: var(--high-contrast-text);
      }
      .high-contrast .screen,
      .high-contrast .header {
        background: var(--high-contrast-bg);
        color: var(--high-contrast-text);
        border: 2px solid var(--high-contrast-text);
      }
      .high-contrast .btn {
        background: var(--high-contrast-button);
        color: var(--high-contrast-bg);
        border: 2px solid var(--high-contrast-text);
      }
      .accessibility-panel {
        position: fixed;
        top: 10px;
        right: 10px;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }
      .accessibility-toggle {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
      }
      .nav-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .back-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
        color: var(--primary-color);
      }
      .loading {
        text-align: center;
        padding: 40px;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @media (max-width: 600px) {
        .app-container {
          padding: 10px;
        }
        .btn {
          font-size: 18px;
          padding: 16px 20px;
        }
        .screen {
          padding: 20px;
        }
      }
      .message {
        padding: 16px;
        border-radius: 8px;
        margin: 16px 0;
        font-weight: 500;
      }
      .message-success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
      }
      .message-error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
      }
      .message-info {
        background: #eff6ff;
        color: #1d4ed8;
        border: 1px solid #bfdbfe;
      }
    </style>
</head>
<body>
  <div class="app-container">
    <div class="accessibility-panel">
      <button class="accessibility-toggle" onclick="toggleContrast()" title="Alternar alto contraste">üîÖ</button>
      <button class="accessibility-toggle" onclick="toggleVoice()" title="Activar/desactivar voz">üîä</button>
    </div>

    <div class="header">
      <div class="logo">JR LibreIA</div>
      <div class="subtitle">Cuaderno Azul - Tu asistente digital personal</div>
    </div>

    <!-- Home -->
    <div id="home-screen" class="screen active">
      <div class="screen-title">¬øQu√© quieres hacer hoy?</div>
      <button class="btn btn-primary" onclick="goToCapture()">üì∑ Escanear p√°gina</button>
      <button class="btn btn-primary" onclick="goToDictate()">üé§ Dictar nota</button>
      <button class="btn btn-secondary" onclick="goToDestinations()">‚öôÔ∏è Configurar destinos</button>
      <button class="btn btn-secondary" onclick="goToHistory()">üóÇÔ∏è Ver historial</button>
    </div>

    <!-- Captura -->
    <div id="capture-screen" class="screen">
      <div class="nav-bar">
        <button class="back-btn" onclick="goToHome()">‚Üê Volver</button>
        <div class="screen-title">Capturar Imagen</div>
        <div></div>
      </div>

      <div class="form-group">
        <div class="image-upload" onclick="document.getElementById('imageInput').click()">
          <div style="font-size:48px;margin-bottom:16px;">üì∑</div>
          <div style="font-size:20px;margin-bottom:8px;">Toca para seleccionar imagen</div>
          <div style="font-size:16px;color:#64748b;">Consejos: buena iluminaci√≥n, texto claro, imagen n√≠tida</div>
        </div>
        <input type="file" id="imageInput" accept="image/*" capture="camera" style="display:none" onchange="handleImageUpload(event)" />
      </div>

      <div id="imagePreviewContainer" style="display:none;">
        <img id="imagePreview" class="image-preview" alt="Vista previa" />
        <button class="btn btn-primary" onclick="processImage()">üîç Procesar con OCR</button>
      </div>
    </div>

    <!-- Dictado -->
    <div id="dictate-screen" class="screen">
      <div class="nav-bar">
        <button class="back-btn" onclick="goToHome()">‚Üê Volver</button>
        <div class="screen-title">Dictar Nota</div>
        <div></div>
      </div>

      <div class="form-group">
        <button id="recordBtn" class="btn btn-primary" onclick="toggleRecording()">üé§ Comenzar dictado</button>
      </div>

      <div class="form-group">
        <label class="label">Texto dictado:</label>
        <textarea id="dictatedText" class="textarea" placeholder="Aqu√≠ aparecer√° tu texto dictado..."></textarea>
      </div>

      <button class="btn btn-success" onclick="processDictatedText()" style="display:none" id="processDictateBtn">‚úÖ Procesar texto</button>
    </div>

    <!-- OCR -->
    <div id="ocr-screen" class="screen">
      <div class="nav-bar">
        <button class="back-btn" onclick="goToCapture()">‚Üê Volver</button>
        <div class="screen-title">Revisar y Editar</div>
        <div></div>
      </div>

      <div id="ocrLoading" class="loading">
        <div class="spinner"></div>
        <div>Procesando imagen con OCR...</div>
        <div style="font-size:16px;color:#64748b;margin-top:8px;">Esto puede tomar unos segundos</div>
      </div>

      <div id="ocrResult" style="display:none;">
        <div class="form-group">
          <label class="label">Texto extra√≠do (puedes editarlo):</label>
          <textarea id="ocrText" class="textarea" rows="8"></textarea>
        </div>
        <div class="form-group">
          <label class="label">Categor√≠a detectada:</label>
          <select id="categorySelect" class="input">
            <option value="GENERAL">üìù General</option>
            <option value="SALUD">üè• Salud</option>
            <option value="COMPRA">üõí Compra</option>
            <option value="LIBRO IA">ü§ñ Libro IA</option>
            <option value="PERSONAL">üë§ Personal</option>
          </select>
        </div>
        <button class="btn btn-success" onclick="goToSend()">üì§ Continuar al env√≠o</button>
      </div>
    </div>

    <!-- Env√≠o -->
    <div id="send-screen" class="screen">
      <div class="nav-bar">
        <button class="back-btn" onclick="goToOCR()">‚Üê Volver</button>
        <div class="screen-title">Enviar Nota</div>
        <div></div>
      </div>

      <div class="form-group">
        <div class="message message-info">
          Categor√≠a: <span id="selectedCategory">GENERAL</span><br />
          Palabras: <span id="wordCount">0</span>
        </div>
      </div>

      <div class="screen-title" style="font-size:20px;">Elige tu destino:</div>
      <button class="btn btn-primary" onclick="sendToMemoriaAzul()" style="background:#2563eb;">üîµ Memoria Azul (Nube)</button>
      <button class="btn btn-danger" onclick="sendToMemoriaRoja()" style="background:#dc2626;">üü• Memoria Roja (Descarga)</button>
      <button class="btn btn-success" onclick="sendToEmail()" style="background:#059669;">‚úâÔ∏è Enviar por Email</button>
      <button class="btn btn-success" onclick="sendToWhatsApp()" style="background:#25d366;">üü¢ Compartir en WhatsApp</button>

      <div id="calendarSection" style="display:none;margin-top:20px;">
        <button class="btn btn-warning" onclick="createCalendarEvent()">üìÖ Crear recordatorio</button>
      </div>
    </div>

    <!-- Destinos -->
    <div id="destinations-screen" class="screen">
      <div class="nav-bar">
        <button class="back-btn" onclick="goToHome()">‚Üê Volver</button>
        <div class="screen-title">Configurar Destinos</div>
        <div></div>
      </div>

      <div class="form-group">
        <h3>Reglas de Categorizaci√≥n</h3>
        <p style="color:#64748b;margin-bottom:20px;">Define palabras clave para categorizar autom√°ticamente tus notas</p>
      </div>

      <div id="rulesContainer"></div>
      <button class="btn btn-secondary" onclick="addNewRule()">‚ûï Agregar nueva regla</button>

      <div style="margin-top:30px;padding-top:20px;border-top:1px solid #e2e8f0;">
        <button class="btn btn-secondary" onclick="exportRules()">üì§ Exportar configuraci√≥n</button>
        <button class="btn btn-secondary" onclick="importRules()">üì• Importar configuraci√≥n</button>
        <input type="file" id="importRulesInput" accept=".json" style="display:none" onchange="handleImportRules(event)" />
      </div>
    </div>

    <!-- Historial -->
    <div id="history-screen" class="screen">
      <div class="nav-bar">
        <button class="back-btn" onclick="goToHome()">‚Üê Volver</button>
        <div class="screen-title">Historial de Notas</div>
        <div></div>
      </div>

      <div id="historyContainer"></div>
      <div style="text-align:center;margin-top:20px;">
        <button class="btn btn-danger" onclick="clearHistory()">üóëÔ∏è Limpiar historial</button>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    // Estado global
    let currentNota = null;
    let isRecording = false;
    let recognition = null;
    let voiceEnabled = false;
    let parsedEvent = null; // fecha/hora detectada

    const defaultRules = [
      { palabrasClave: ["m√©dico", "doctor", "receta", "medicina", "hospital", "cita m√©dica"], destino: "SALUD", carpeta: "Salud" },
      { palabrasClave: ["compra", "comprar", "lista", "supermercado", "tienda", "mercadona"], destino: "COMPRA", carpeta: "Compras" },
      { palabrasClave: ["idea", "cap√≠tulo", "IA", "inteligencia artificial", "libro", "escribir", "Cuaderno Azul"], destino: "LIBRO IA", carpeta: "Libro IA" },
    ];

    document.addEventListener("DOMContentLoaded", initApp);

    function initApp() {
      // reglas en localStorage
      if (!localStorage.getItem("jr-libreia-rules")) {
        localStorage.setItem("jr-libreia-rules", JSON.stringify(defaultRules));
      }
      loadRules();
      loadHistory();

      // Reconocimiento de voz
      if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = "es-ES";
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.onresult = (event) => {
          let finalTranscript = "";
          for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
              finalTranscript += event.results[i][0].transcript;
            }
          }
          if (finalTranscript) {
            document.getElementById("dictatedText").value += finalTranscript + " ";
          }
        };
        recognition.onerror = (e) => {
          console.error("Error de reconocimiento de voz:", e.error);
          stopRecording();
        };
      }

      // Drag&drop imagen
      const imageUpload = document.querySelector(".image-upload");
      imageUpload.addEventListener("dragover", (e) => {
        e.preventDefault();
        imageUpload.classList.add("dragover");
      });
      imageUpload.addEventListener("dragleave", () => imageUpload.classList.remove("dragover"));
      imageUpload.addEventListener("drop", (e) => {
        e.preventDefault();
        imageUpload.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith("image/")) {
          handleImageFile(files[0]);
        }
      });

      speak("Bienvenido a JR LibreIA - Cuaderno Azul. Tu asistente digital personal.");
    }

    // Navegaci√≥n
    function showScreen(id) {
      document.querySelectorAll(".screen").forEach((s) => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }
    function goToHome() { showScreen("home-screen"); speak("Pantalla principal"); }
    function goToCapture() { showScreen("capture-screen"); speak("Capturar imagen. Selecciona una foto con texto para escanear."); }
    function goToDictate() { showScreen("dictate-screen"); speak("Dictar nota. Pulsa el bot√≥n para comenzar a hablar."); }
    function goToDestinations() { showScreen("destinations-screen"); speak("Configurar destinos y reglas de categorizaci√≥n."); }
    function goToHistory() { showScreen("history-screen"); loadHistory(); speak("Historial de notas guardadas."); }
    function goToOCR() { showScreen("ocr-screen"); }
    function goToSend() {
      // recoger texto/categor√≠a editados
      const text = document.getElementById("ocrText").value || "";
      const cat = document.getElementById("categorySelect").value || "GENERAL";
      if (currentNota) {
        currentNota.texto = text;
        currentNota.categorias = [cat];
      }
      showScreen("send-screen");
      updateSendScreen();
      speak("Elige el destino para tu nota.");
    }

    // Imagen
    function handleImageUpload(e) { const file = e.target.files[0]; if (file) handleImageFile(file); }
    function handleImageFile(file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        const preview = document.getElementById("imagePreview");
        const container = document.getElementById("imagePreviewContainer");
        preview.src = ev.target.result;
        container.style.display = "block";
        speak("Imagen cargada correctamente. Pulsa procesar con OCR cuando est√©s listo.");
      };
      reader.readAsDataURL(file);
    }

    // OCR
    async function processImage() {
      showScreen("ocr-screen");
      document.getElementById("ocrLoading").style.display = "block";
      document.getElementById("ocrResult").style.display = "none";
      const imageElement = document.getElementById("imagePreview");
      try {
        speak("Procesando imagen. Esto puede tomar unos segundos.");
        const result = await Tesseract.recognize(imageElement, "spa", {
          logger: (m) => {
            if (m.status === "recognizing text") {
              console.log(`Progreso OCR: ${Math.round(m.progress * 100)}%`);
            }
          },
        });
        const extractedText = (result.data.text || "").trim();
        document.getElementById("ocrText").value = extractedText;
        const category = detectCategory(extractedText);
        document.getElementById("categorySelect").value = category;
        currentNota = {
          id: Date.now(),
          fechaISO: new Date().toISOString(),
          fuente: "foto",
          texto: extractedText,
          categorias: [category],
          imagenOriginal: imageElement.src,
          archivos: {},
          destino: "",
          estado: "procesada",
        };
        document.getElementById("ocrLoading").style.display = "none";
        document.getElementById("ocrResult").style.display = "block";
        speak(`Texto extra√≠do correctamente. Categor√≠a detectada: ${category}. Puedes editar el texto si es necesario.`);
      } catch (err) {
        console.error("Error OCR:", err);
        document.getElementById("ocrLoading").style.display = "none";
        document.getElementById("ocrResult").innerHTML = `<div class="message message-error">No he podido leer la imagen. Prueba con m√°s luz o mayor nitidez.</div>`;
        document.getElementById("ocrResult").style.display = "block";
        speak("No he podido leer la imagen. Int√©ntalo de nuevo con m√°s luz o mayor nitidez.");
      }
    }

    // Dictado
    function toggleRecording() {
      if (!recognition) {
        alert("Tu navegador no soporta dictado por voz.");
        return;
      }
      if (!isRecording) {
        recognition.start();
        isRecording = true;
        document.getElementById("recordBtn").textContent = "‚èπÔ∏è Detener dictado";
        document.getElementById("processDictateBtn").style.display = "block";
        speak("Grabando. Puedes empezar a hablar.");
      } else {
        stopRecording();
      }
    }
    function stopRecording() {
      if (recognition && isRecording) {
        recognition.stop();
        isRecording = false;
        document.getElementById("recordBtn").textContent = "üé§ Comenzar dictado";
        speak("Dictado detenido.");
      }
    }
    function processDictatedText() {
      stopRecording();
      const text = (document.getElementById("dictatedText").value || "").trim();
      if (!text) {
        alert("No hay texto dictado.");
        return;
      }
      const category = detectCategory(text);
      currentNota = {
        id: Date.now(),
        fechaISO: new Date().toISOString(),
        fuente: "voz",
        texto: text,
        categorias: [category],
        archivos: {},
        destino: "",
        estado: "procesada",
      };
      document.getElementById("ocrText").value = text;
      document.getElementById("categorySelect").value = category;
      showScreen("ocr-screen");
      document.getElementById("ocrLoading").style.display = "none";
      document.getElementById("ocrResult").style.display = "block";
      speak(`Texto dictado preparado. Categor√≠a detectada: ${category}.`);
    }

    // Categorizaci√≥n
    function detectCategory(text) {
      const rules = JSON.parse(localStorage.getItem("jr-libreia-rules") || "[]");
      const t = (text || "").toLowerCase();
      for (const r of rules) {
        for (const k of r.palabrasClave) {
          if (t.includes(k.toLowerCase())) return r.destino || "GENERAL";
        }
      }
      return "GENERAL";
    }

    // Fecha/hora
    function detectDateTime(text) {
      // patrones simples dd/mm, dd-mm, horas tipo 10h o 10:30
      const t = (text || "").toLowerCase();
      const days = ["domingo","lunes","martes","mi√©rcoles","miercoles","jueves","viernes","s√°bado","sabado"];
      let date = null;
      let time = null;
      // fecha
      const m1 = t.match(/(\b\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/);
      if (m1) {
        const d = parseInt(m1[1], 10);
        const mo = parseInt(m1[2], 10) - 1;
        const y = m1[3] ? parseInt(m1[3], 10) : new Date().getFullYear();
        date = new Date(y, mo, d);
      }
      // d√≠a de semana
      for (let i = 0; i < days.length; i++) {
        if (t.includes(days[i])) {
          const target = (i === 0 ? 0 : i); // domingo=0, lunes=1...
          const now = new Date();
          const diff = (target + 7 - now.getDay()) % 7 || 7; // pr√≥ximo d√≠a
          const d2 = new Date(now);
          d2.setDate(now.getDate() + diff);
          date = date || d2;
          break;
        }
      }
      // hora
      const m2 = t.match(/\b(\d{1,2})(?::(\d{2}))?\s*(h|horas|am|pm)?/);
      if (m2) {
        let h = parseInt(m2[1], 10);
        let mi = m2[2] ? parseInt(m2[2], 10) : 0;
        const suf = m2[3] || "";
        if (suf.includes("pm") && h < 12) h += 12;
        time = { h, mi };
      }
      if (!date) return null;
      if (!time) time = { h: 10, mi: 0 };
      const dt = new Date(date);
      dt.setHours(time.h, time.mi, 0, 0);
      return dt;
    }

    // Env√≠o
    function updateSendScreen() {
      const cat = currentNota?.categorias?.[0] || "GENERAL";
      const txt = (currentNota?.texto || "").trim();
      document.getElementById("selectedCategory").textContent = cat;
      document.getElementById("wordCount").textContent = txt ? txt.split(/\s+/).length : 0;
      parsedEvent = detectDateTime(txt);
      document.getElementById("calendarSection").style.display = parsedEvent ? "block" : "none";
    }

    async function sendToMemoriaAzul() {
      if (!currentNota) return;
      const zip = await buildZip({ includeImage: true, includePdf: true, includeTxt: true });
      triggerDownload(zip, fileBaseName() + "_MemoriaAzul.zip");
      saveToHistory("Memoria Azul");
      alert("Paquete listo. Sube el ZIP a tu nube (Drive/Dropbox).");
      speak("Paquete preparado para Memoria Azul. Puedes subirlo a tu nube.");
    }

    async function sendToMemoriaRoja() {
      if (!currentNota) return;
      const zip = await buildZip({ includeImage: true, includePdf: true, includeTxt: true });
      triggerDownload(zip, fileBaseName() + "_MemoriaRoja.zip");
      saveToHistory("Memoria Roja");
      alert("Descargado. Copia el ZIP a tu USB (Bot√≥n Rojo).");
      speak("Descarga completada para Memoria Roja.");
    }

    function sendToEmail() {
      if (!currentNota) return;
      const subject = encodeURIComponent("JR LibreIA ‚Äì Nota");
      const body = encodeURIComponent(currentNota.texto || "");
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
      saveToHistory("Email");
    }

    function sendToWhatsApp() {
      if (!currentNota) return;
      const text = encodeURIComponent(currentNota.texto || "");
      window.open(`https://wa.me/?text=${text}`, "_blank");
      saveToHistory("WhatsApp");
    }

    function createCalendarEvent() {
      if (!currentNota) return;
      const dt = parsedEvent || promptForDateTime();
      if (!dt) {
        alert("No se pudo crear el evento.");
        return;
      }
      const ics = buildICS(dt, (currentNota.texto || "Nota"));
      const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
      triggerDownload(blob, fileBaseName() + ".ics");
      saveToHistory("ICS");
      speak("Evento de calendario creado.");
    }

    function promptForDateTime() {
      const d = prompt("Fecha (YYYY-MM-DD)", new Date().toISOString().slice(0, 10));
      if (!d) return null;
      const h = prompt("Hora (HH:MM)", "10:00");
      const [H, M] = (h || "10:00").split(":").map((x) => parseInt(x, 10));
      const dt = new Date(d + "T00:00:00");
      dt.setHours(H || 10, M || 0, 0, 0);
      return dt;
    }

    function buildICS(dateObj, summary) {
      const pad = (n) => String(n).padStart(2, "0");
      const y = dateObj.getFullYear();
      const mo = pad(dateObj.getMonth() + 1);
      const d = pad(dateObj.getDate());
      const h = pad(dateObj.getHours());
      const mi = pad(dateObj.getMinutes());
      const dt = `${y}${mo}${d}T${h}${mi}00`;
      return `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//JR LibreIA//Cuaderno Azul//ES\nBEGIN:VEVENT\nUID:${Date.now()}@jr-libreia\nDTSTAMP:${dt}Z\nDTSTART:${dt}Z\nSUMMARY:${(summary || "Nota").replace(/\n/g, " ")}\nEND:VEVENT\nEND:VCALENDAR`;
    }

    // Construcci√≥n de archivos
    function fileBaseName() {
      const cat = currentNota?.categorias?.[0] || "GENERAL";
      const ts = new Date(currentNota?.fechaISO || Date.now());
      const pad = (n) => String(n).padStart(2, "0");
      const name = `JR_${ts.getFullYear()}-${pad(ts.getMonth() + 1)}-${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}_${cat}`;
      return name;
    }

    async function buildZip(opts = { includeImage: true, includePdf: true, includeTxt: true }) {
      const zip = new JSZip();
      const base = fileBaseName();
      // TXT
      if (opts.includeTxt) {
        const txtBlob = generateTxtBlob();
        zip.file(base + ".txt", await blobToArrayBuffer(txtBlob));
      }
      // PDF
      if (opts.includePdf) {
        const pdfBlob = await generatePdfBlob();
        zip.file(base + ".pdf", await blobToArrayBuffer(pdfBlob));
      }
      // Imagen
      if (opts.includeImage && currentNota?.imagenOriginal) {
        const data = currentNota.imagenOriginal.split(",")[1];
        zip.file(base + ".jpg", data, { base64: true });
      }
      const content = await zip.generateAsync({ type: "blob" });
      return content;
    }

    function generateTxtBlob() {
      const meta = `Categoria: ${currentNota?.categorias?.[0] || "GENERAL"}\nFecha: ${currentNota?.fechaISO}\nFuente: ${currentNota?.fuente}\n\n`;
      const body = (currentNota?.texto || "").trim() + "\n";
      return new Blob([meta + body], { type: "text/plain;charset=utf-8" });
    }

    async function generatePdfBlob() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const margin = 40;
      let y = margin;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("JR LibreIA ‚Äì Nota", margin, y);
      y += 20;
      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);
      doc.text(`Categor√≠a: ${currentNota?.categorias?.[0] || "GENERAL"}`, margin, y);
      y += 16;
      doc.text(`Fecha: ${new Date(currentNota?.fechaISO || Date.now()).toLocaleString()}`, margin, y);
      y += 24;
      const text = (currentNota?.texto || "").trim();
      const split = doc.splitTextToSize(text, 515);
      doc.text(split, margin, y);
      y += split.length * 14 + 16;
      if (currentNota?.imagenOriginal) {
        try {
          const img = currentNota.imagenOriginal;
          const imgProps = doc.getImageProperties(img);
          const maxW = 515;
          const ratio = imgProps.width ? maxW / imgProps.width : 1;
          const w = maxW;
          const h = imgProps.height ? imgProps.height * ratio : 200;
          if (y + h + margin > doc.internal.pageSize.getHeight()) {
            doc.addPage();
            y = margin;
          }
          doc.addImage(img, "JPEG", margin, y, w, h);
        } catch {}
      }
      return doc.output("blob");
    }

    function triggerDownload(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }

    function blobToArrayBuffer(blob) {
      return new Promise((res) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.readAsArrayBuffer(blob);
      });
    }

    // Reglas UI
    function loadRules() {
      const rules = JSON.parse(localStorage.getItem("jr-libreia-rules") || "[]");
      const c = document.getElementById("rulesContainer");
      c.innerHTML = "";
      rules.forEach((r, idx) => c.appendChild(ruleRow(r, idx)));
    }

    function ruleRow(rule, idx) {
      const wrap = document.createElement("div");
      wrap.className = "history-item";
      wrap.innerHTML = `
        <div class="form-group">
          <label class="label">Destino:</label>
          <input class="input" id="dest_${idx}" value="${rule.destino || "GENERAL"}" />
        </div>
        <div class="form-group">
          <label class="label">Carpeta:</label>
          <input class="input" id="carp_${idx}" value="${rule.carpeta || "General"}" />
        </div>
        <div class="form-group">
          <label class="label">Palabras clave (separadas por coma):</label>
          <input class="input" id="keys_${idx}" value="${(rule.palabrasClave || []).join(", ")}" />
        </div>
        <div class="history-actions">
          <button class="btn btn-success btn-small" onclick="saveRule(${idx})">üíæ Guardar</button>
          <button class="btn btn-danger btn-small" onclick="deleteRule(${idx})">üóëÔ∏è Borrar</button>
        </div>
      `;
      return wrap;
    }

    function saveRule(idx) {
      const rules = JSON.parse(localStorage.getItem("jr-libreia-rules") || "[]");
      const dest = document.getElementById(`dest_${idx}`).value || "GENERAL";
      const carp = document.getElementById(`carp_${idx}`).value || "General";
      const keys = (document.getElementById(`keys_${idx}`).value || "")
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean);
      rules[idx] = { destino: dest, carpeta: carp, palabrasClave: keys };
      localStorage.setItem("jr-libreia-rules", JSON.stringify(rules));
      speak("Regla guardada.");
    }

    function deleteRule(idx) {
      const rules = JSON.parse(localStorage.getItem("jr-libreia-rules") || "[]");
      rules.splice(idx, 1);
      localStorage.setItem("jr-libreia-rules", JSON.stringify(rules));
      loadRules();
      speak("Regla eliminada.");
    }

    function addNewRule() {
      const rules = JSON.parse(localStorage.getItem("jr-libreia-rules") || "[]");
      rules.push({ destino: "GENERAL", carpeta: "General", palabrasClave: [] });
      localStorage.setItem("jr-libreia-rules", JSON.stringify(rules));
      loadRules();
    }

    function exportRules() {
      const rules = localStorage.getItem("jr-libreia-rules") || "[]";
      const blob = new Blob([rules], { type: "application/json;charset=utf-8" });
      triggerDownload(blob, "JR_LibreIA_rules.json");
    }

    function importRules() {
      document.getElementById("importRulesInput").click();
    }

    function handleImportRules(e) {
      const file = e.target.files[0];
      if (!file) return;
      const fr = new FileReader();
      fr.onload = () => {
        try {
          JSON.parse(fr.result);
          localStorage.setItem("jr-libreia-rules", fr.result);
          loadRules();
          speak("Reglas importadas.");
        } catch (err) {
          alert("Archivo inv√°lido.");
        }
      };
      fr.readAsText(file);
    }

    // Historial
    function loadHistory() {
      const list = JSON.parse(localStorage.getItem("jr-libreia-history") || "[]");
      const c = document.getElementById("historyContainer");
      c.innerHTML = "";
      if (!list.length) {
        c.innerHTML = '<div class="message message-info">A√∫n no hay notas guardadas.</div>';
        return;
      }
      list.sort((a, b) => b.id - a.id);
      list.forEach((n) => {
        const it = document.createElement("div");
        it.className = "history-item";
        it.innerHTML = `
          <div class="history-meta">${new Date(n.fechaISO).toLocaleString()} ‚Ä¢ ${n.categorias?.[0] || "GENERAL"} ‚Ä¢ ${n.destino}</div>
          <div class="history-preview">${(n.texto || "").slice(0, 180)}${(n.texto || "").length > 180 ? "‚Ä¶" : ""}</div>
          <div class="history-actions">
            <button class="btn btn-secondary btn-small" onclick='reopenNota(${JSON.stringify(n.id)})'>üîÅ Reabrir</button>
            <button class="btn btn-secondary btn-small" onclick='downloadTxt(${JSON.stringify(n.id)})'>üìÑ TXT</button>
            <button class="btn btn-secondary btn-small" onclick='downloadPdf(${JSON.stringify(n.id)})'>üßæ PDF</button>
            <button class="btn btn-secondary btn-small" onclick='downloadZip(${JSON.stringify(n.id)})'>üóúÔ∏è ZIP</button>
          </div>
        `;
        c.appendChild(it);
      });
    }

    function saveToHistory(destino) {
      if (!currentNota) return;
      const list = JSON.parse(localStorage.getItem("jr-libreia-history") || "[]");
      const nota = { ...currentNota, destino };
      list.push(nota);
      localStorage.setItem("jr-libreia-history", JSON.stringify(list));
      loadHistory();
    }

    function clearHistory() {
      if (!confirm("¬øSeguro que quieres borrar todo el historial?")) return;
      localStorage.removeItem("jr-libreia-history");
      loadHistory();
    }

    function getNotaById(id) {
      const list = JSON.parse(localStorage.getItem("jr-libreia-history") || "[]");
      return list.find((n) => n.id === id);
    }

    function reopenNota(id) {
      const n = getNotaById(id);
      if (!n) return;
      currentNota = n;
      document.getElementById("ocrText").value = n.texto || "";
      document.getElementById("categorySelect").value = n.categorias?.[0] || "GENERAL";
      showScreen("ocr-screen");
      document.getElementById("ocrLoading").style.display = "none";
      document.getElementById("ocrResult").style.display = "block";
    }

    async function downloadTxt(id) {
      const n = getNotaById(id);
      if (!n) return;
      const meta = `Categoria: ${n.categorias?.[0] || "GENERAL"}\nFecha: ${n.fechaISO}\nDestino: ${n.destino}\n\n`;
      const blob = new Blob([meta + (n.texto || "")], { type: "text/plain;charset=utf-8" });
      const name = `JR_${new Date(n.fechaISO).toISOString().slice(0, 16).replace(/[:T]/g, "-")}_${n.categorias?.[0] || "GENERAL"}.txt`;
      triggerDownload(blob, name);
    }

    async function downloadPdf(id) {
      const n = getNotaById(id);
      if (!n) return;
      const backup = currentNota; // reutilizar generador
      currentNota = n;
      const blob = await generatePdfBlob();
      currentNota = backup;
      const name = `JR_${new Date(n.fechaISO).toISOString().slice(0, 16).replace(/[:T]/g, "-")}_${n.categorias?.[0] || "GENERAL"}.pdf`;
      triggerDownload(blob, name);
    }

    async function downloadZip(id) {
      const n = getNotaById(id);
      if (!n) return;
      const backup = currentNota;
      currentNota = n;
      const zip = await buildZip({ includeImage: true, includePdf: true, includeTxt: true });
      currentNota = backup;
      const name = `JR_${new Date(n.fechaISO).toISOString().slice(0, 16).replace(/[:T]/g, "-")}_${n.categorias?.[0] || "GENERAL"}.zip`;
      triggerDownload(zip, name);
    }

    // Accesibilidad
    function toggleContrast() {
      document.body.classList.toggle("high-contrast");
    }
    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      speak(voiceEnabled ? "Voz activada" : "Voz desactivada");
    }
    function speak(text) {
      try {
        if (!voiceEnabled) return;
        if (!("speechSynthesis" in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "es-ES";
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      } catch {}
    }
  </script>
</body>
</html>